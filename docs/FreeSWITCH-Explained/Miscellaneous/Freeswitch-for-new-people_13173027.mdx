# 对于新手的FreeSWITCH指南

## 关于

这是一篇简单易懂的FreeSWITCH快速入门指南。我们假设您已经安装了FreeSWITCH（或者将在应用本指南之前安装），了解XML是什么，知道正则表达式是什么，知道如何编译某些东西，或者至少可以按照指示操作，而且您需要一个简单的文件编辑器。除此之外，我们将为您提供其他所有所需的内容。

这个教程不包含以下内容：

1. 对于电话技术一般原理的介绍，尽管我们会涉及一些VoIP的基础知识。
2. 对于开发FreeSWITCH的任何内容的教程。这些内容在其他地方有介绍。
3. 讨论特定的模块（除了一些基础的示例需要的模块）。
4. 对于使用FreeSWITCH的具体操作的教程。我们的示例是通用而广泛的。

同时，需要注意的是，这篇文档并不是要提供逐字逐句和技术层面上准确的内容。如果我们说“这是一只熊”，它可能实际上并不是一只熊，但如果您把它看作是一只熊，那么这将为您提供一个良好的起点。

让我们开始来谈谈FreeSWITCH。当您安装FreeSWITCH时，您将选择安装某些模块。其中一些最常见的模块，例如[mod\_sofia](../Modules/mod_sofia_1048707.mdx#about)，在modules.conf中是不用注释的（它只用于安装，与在实际使用中的modules.conf.xml不同）。实际上，您可以不需要任何模块来运行FreeSWITCH。因为FreeSWITCH本身并不是指mod_sofia，亦不是[mod\_skypiax](../Modules/mod_skypopen_3966336.mdx#-sk-)或[mod\_fifo](../Modules/mod_fifo_3966031.mdx#-add)。它只是附带了这些模块。

FreeSWITCH是一个基于软件的交换机。具体而言，它通过各种方式连接数据通道，并对其进行处理。FreeSWITCH与其核心外部的连接方式是通过模块进行的。它通过mod\_sofia连接到SIP客户端，通过mod\_skypiax连接到Skype。这些模块与FreeSWITCH的API进行了集成，为FreeSWITCH提供了它所期望的数据流以及关于如何处理这些数据的一些信息。

也许这与您对FreeSWITCH的期望不太相符，但请考虑以下示例。如果您的房子的每个房间都有麦克风和扬声器，并且有一个模块可以将它们连接起来，您就可以在整个房子内进行通信，并且可以从房子中的一个房间连接到任何其他类型的数据通道，例如电话线或SIP目标。您可以使用FreeSWITCH将音乐流式传输到房子的不同房间。您可以使用FreeSWITCH在一个房间和另一个房间之间进行视频连接。FreeSWITCH的作用就是以最佳方式将不同的通道连接在一起，并在其生命周期内保持对这些通道的大量信息。

更具体地说，您可以通过mod\_sofia使SIP客户端连接到FreeSWITCH，并通过其他一些模块将其连接到硬线上，具体取决于该线路的配置。

这就是FreeSWITCH与大多数其他PBX平台不同的地方。FreeSWITCH不是一个PBX，而是一个软件交换机。许多人使用它来构建一个在其基础上包含PBX功能（以及其他功能）的系统。您可以通过模块以及一些配置数据（主要是XML文件）来实现这一点。

请注意，并非所有模块都用于创建FreeSWITCH所使用的通道。相反，如果不是大多数的话，其中许多模块用于扩展如何处理那些通道的功能到其他领域。例如，mod\_fifo创建了使用先进先出式排队处理呼叫的能力。你可能会使用[mod\_conference](../Modules/mod_conference_3965534.mdx#list)。令人惊讶的是，它会为您设置会议呼叫，供其他模块使用。

在设置FreeSWITCH时，您需要考虑您软交换所需的功能以及您不需要的功能。许多用户使用mod\_sofia进行SIP客户端和服务提供商。您不必这样做。您可以轻松地将FreeSWITCH用于您家庭或办公室中通过某些数字卡连接的模拟电话，并通过连接到另一张卡上的Voice T1连接到电话系统。

有了这些基础知识，让我们来了解一些FreeSWITCH逻辑的基础知识。

点击此处展开目录

* 1 [变量](#variables)
* 2 [目录](#directory)
* 3 [呼叫计划](#dialplan)

#### 变量

在所谓的“示例配置”或有时称为“默认配置”中，为您自动设置了某些变量。当您安装FreeSWITCH时，位于安装目录下（通常是Linux机器上的/usr/local/freeswitch/）的一个名为“freeswitch.xml”的文件是FreeSWITCH开始加载其配置的位置。

这个 XML 文件是一组 include 条目，你可能已经猜到了。在撰写本文时，它有几个部分。首先，它包含 vars.xml。然后它有配置、拨号计划、目录和短语的部分。在运行 FreeSWITCH 时，你可以发出 [reloadxml](FAQ/index.mdx#q-does-reloadxml-reload-all-xml-files) 命令，它将重新读取此文档的所有 XML，但只能应用部分更改，而不是所有更改。刷新后不会更新的大部分内容位于 vars.xml 和特定模块的配置文件中。例如，sofia profile 数据不会刷新，因为这是在启动时提供给 mod_sofia 的。要刷新 sofia profile，必须向 sofia 本身发出单独的命令。我们稍后会详细介绍。

拨号计划和目录都会根据其中的内容进行刷新。因此，如果你添加了一个用户或新的拨号计划部分，通过 reloadxml 将得到这些内容。但是，正在进行的通话或呼叫目标（如会议、FIFO 和活动通道）不会刷新。请记住这一点，因为它在许多情况下可能引起一些困惑。一个例子是正在进行的会议，如果在配置中进行更改，直到会议结束后才会应用这些更改。这并不像你想象的那样有限制，但它确实防止了在使用活动通道时自射脚自己。

短语部分告诉 FreeSWITCH 如何获取可用的语音短语。你可能现在用不到它，所以目前并不是非常重要。只要记住，如果你进行文本转语音时，它会派上用场。

`vars.xml`文件中包含与整个交换机相关的设置。当考虑诸如默认使用的编解码器、默认的IP地址和网关信息以及要填充哪些**变量**时，这一点尤为重要。其中一个**重要**的要素是默认密码。这是用户在注册FreeSWITCH时使用的密码，在示例配置中广泛存在。请立即更改它。

在这个文件中需要注意的几个方面是：

1. `domain`和`domain_name`用作此FreeSWITCH安装的默认域。如果可能的话，请为它们使用一个完全限定域名(FQDN)。您可以在配置中使用多个域，但在未指定时应定义默认域。
2. `sound_prefix`是您的声音文件目录所在的基本目录，也是您的提示音的基础目录。
3. `global_codec_prefs`和`outbound_codec_prefs`就是这样。用于连接到终端和从终端连接的编解码器偏好设置。`outbound`是用于FreeSWITCH打开的通道的编解码器偏好设置，而不是创建的通道**连接**到FreeSWITCH。

在这里设置了许多更多的变量，你在更具体的探索FreeSWITCH时会了解到。我们将它们称为变量，是因为它们在配置文件的其他地方使用。这很重要，因为你需要很多模块来知道它们应该查看的IP地址、应该使用哪些编解码器等等。你不想在很多地方进行设置，而是想尽可能少地设置。因此，我们有在拨号计划、目录、sofia配置或其他地方使用的变量。在其他地方使用它们的方式是$${varname}。请注意两个$符号。还有其他一些变量称为[\_\_Channel Variables](../Dialplan/Variables-Archive/x__Channel-Variables_1048892.mdx#--)，它们只有一个$，有时还有一些其他的语法差异。$$变量在FreeSWITCH将配置加载到内存时仅被使用一次，并且仅在reloadxml事件期间重新评估。

所以如果我在vars.xml中声明一个变量，像这样：

```xml
<X-PRE-PROCESS cmd="set" data="my_var=my_data"/>
```

你应该注意到关于此的两件事。首先，X-PRE-PROCESS表示这不是实际的配置数据。这是为了让FreeSWITCH在构建内存中的XML配置时进行评估的，无论是在首次启动还是在reloadxml时。因此，它将"my\_data"字符串存储在"my\_var"中，供该进程的剩余时间使用。然后，当我想在配置的其他地方使用这些数据时，可以这样做：

```xml
<extension name="$${my_var}">
```

这将在内存中运行的最终配置中将该扩展的名称设置为"my\_data"。

查看大部分XML在运行FreeSWITCH并处理信息后的样子的一个好方法是查看日志目录（通常是/usr/local/freeswitch/log/），并打开freeswitch.xml.fsxml文件。这个文件包含了FreeSWITCH在上次加载到内存中看到的所有内容。

现在是一个好时机查看freeswitch/conf/autoload\_configs目录下的配置文件。只需了解其中的内容，浏览一下你找到的有趣的模块，记下以后想要尝试的模块。大部分模块你不需要改动。为了安全起见，你可能想查看acl.conf.xml文件，对于启动时启用/禁用其他模块，你可能想查看前面我们讨论过的modules.conf.xml文件。记住，它与你构建时的modules.conf文件是**不同**的。它们通常有很强的相关性，但它们并不是同一个文件，也没有相同的格式。

#### 目录

在我们进一步之前，我们应该先看看用户。大多数人在开始尝试更多动态配置的其他方面之前都需要用户。请进入freeswitch/conf/directory文件夹。你会注意到有一个default.xml文件和一个default文件夹。这是因为default.xml文件（请打开它）在其用户部分会包含default文件夹中的.xml文件。

Default.xml非常详细地进行了注释,但是它在这里再次使用了“domain”这一术语，你可能还记得它出现在vars.xml中不久之前。Domain是这些用户注册时所属的分组。你可以把它想象成电子邮件中的FQDN。[name@domain.com](mailto:name@domain.com)是电子邮件的格式，而发送到[name@otherdomain.com](mailto:name@otherdomain.com)的邮件通常不会发到同一个人那里，这在这里也是一样的。用户被分组在一个域名的范围内，而你在vars.xml中指定的域名则是用户所属的默认域名。你会注意到这行代码：

```xml
<domain name="$${domain}">
```

它使用了在vars.xml中定义的‘domain’变量来填充这个字段。你可以为不同的公司、不同的部门或者其他任何原因不想将其分组的用户创建不同的域名。你可以把id想象成传统意义上的“分机号码”。如果我的id是1003，你在与别人交流时可能会称呼我的分机号码为1003。正如后面我们会看到的，它们并不一样，但是它们可以是相同的。

在default目录下，有许多为不同用户创建的.xml文件。它们为了组织的目的而被分开，但其实并不一定非得这样。如果你不想这样的话，可以不用这样做。当你需要手动维护用户时，为每个用户创建一个新的文件，然后当你拒绝该用户的访问时，只需删除该文件或将其重命名为不是.xml结尾的名称。

在对目录进行更改后，请记得使用reloadxml或重启FreeSWITCH。关于该目录及其格式的更详细信息，请参考[XML用户目录指南](../Directory/XML-User-Directory/index.mdx#about)。 

#### 拨号计划

现在我们来到每个人都谈论的部分，也是FreeSWITCH中大多数人都感到沮丧的部分：拨号计划。

事实上，我们撒了一个小谎。还记得在一开始我们说过你需要了解正则表达式吗？我们不是开玩笑的。在继续之前，你应该先了解它，因为拨号计划在许多拨号计划功能中都使用了正则表达式。如果你还不了解，我们建议你快速尝试[这个网站](http://www.regular-expressions.info/quickstart.html)。别担心，我们会等着你。

拨号计划简单来说就是一组路由信息。在我们继续之前，有两个要注意的地方。

首先，拨号计划是一次性“执行”的。这意味着如果你在一个分机中设置了一些变量，例如用于时间逻辑的变量，并且在文件的其他位置使用这些变量，它是不会生效的。两个分机在同一个步骤中被处理，它们无法相互访问。对于这种逻辑，你必须将所有变量放在同一个分机中，或者通过将呼叫再次发送到拨号计划中的另一个分机来处理。这样，它就是另一个步骤了，之前的所有分机中设置的变量都可供你使用。

其次，只有当FreeSWITCH不知道如何处理呼叫时，才会遍历拨号计划。所以如果目标地址不明确，它将遍历拨号计划寻找路由。如果你告诉它通过特定的sofia接口进行外呼，它就不会查看拨号计划。如果你告诉它去1003，它将遍历拨号计划。

这就是目录中ID和分机之间的差异所在。1003是一个用户。1003也可以是该用户的分机，但不一定如此。这取决于你。你可以这样做，如果有人拨打数字3，它会转到用户1003。你可以让1003和3都转到用户1003。你也可以不设置，这样就没有人可以呼叫用户1003。然后1003只能拨打电话，这里没有限制。

分机在`<extension>`标签中获取组，并在内部设置一组`<condition>`标签。条件标签包含`<action>`标签。你可以自由组织这些标签，但请记住，这是最灵活的设置方式。当有一个呼叫进来时，它会查看每个分机。在分机中，它按顺序查看条件标签。如果第一个条件不成立，它就会离开该分机，并停止检查之后的条件。

##### 带有注释的拨号计划分机示例：

```xml
<!-- 这是扩展名称，主要用于人类识别。
        你可以称其为1485284，FreeSWITCH不会有任何不同对待。尽量描述性一些。-->
<extension name="音调流">
    <!-- 这是我们的第一个条件。这是最常见的条件。
         它只检查目的地是否完全为"9198"，通过一个正则表达式来匹配。
         它不会匹配其他任何内容。-->
    <condition field="destination_number" expression="^9198$">
	    <!-- 如果条件成立，我们接听电话。 -->
        <action application="answer"/>
	    <!-- 然后接着，假设呼叫者仍在线，我们将向他们播放tetris.ttml文件，播放两次。
	         如果需要的话，我们可以播放wav文件或其他文件，或者执行其他任何操作。 -->
        <action application="playback" data="tone_stream://path=${base_dir}/conf/tetris.ttml;loops=2"/>
```

```html
<!-- 这就是这个条件标签的全部内容了，我们想要在这个呼叫流程中添加更多内容，所以关闭这个标签以便检查其他一些条件并进行一些操作。 -->
</condition>
<!-- 首先，我们检查一个通道变量，该变量在之前的拨号计划评估中必须已设置。只有当条件满足时，才会继续进行控制。 -->
<condition field="${sales_campaign_on}" expresion="^true$"/>
<!-- 接下来，如果通道变量匹配，我们可以根据是否在工作时间或非工作时间来执行某些操作。 -->
<condition wday="2-6" hour="7-17">
  <!-- 如果这个以及所有以前的条件都为真，我们已经完成了前一个在destination_number条件下设置的动作集，并且现在想要做更多的事情。首先，在拨号计划中设置一个通道变量以备后用。 -->
  <action application="set" data="business_open=true"/>
  <!-- 接下来，我们将其转移到销售组目标，我们将其称为“2000”，因为它可以从其他地方拨打。如果我们不希望通过数字拨号，我们可以将其命名为“sales_group”（如果我们选择的话）。我们告诉它通过XML拨号计划进入默认上下文。 -->
  <action application="transfer" data="2000 XML default"/>
  <!-- 如果条件为真，呼叫流程刚刚从这个分机转移到了销售组。但是，如果所有以前的条件都为真，但是最后一个条件（时间）不为真，则我们仍然希望执行某些操作。所以我们有了一个反操作，它与操作相同，但在其包含的条件为假时执行。首先，我们将同样的通道变量从true更改为false。 -->
  <anti-action application="set" data="business_open=false"/>
  <!-- 然后，我们播放我们的销售信息，而不是将其转移。请注意，该文件的目录是完整目录。它不一定要这样，但您可以在某个地方使用变量，例如$${base_dir}。 -->
  <anti-action application="playback" data="/usr/local/freeswitch/sounds/sales/sales_campaign_135.wav"/>
  <!-- 从技术上讲，如果您的分机中有continue="true"，您不需要明确进行挂断。这只是为了展示给您看。
  <anti-action application="hangup"/>
 <!-- 动作列表结束，所以我们关闭这个条件标签。
 </condition>
<!-- 我们也关闭扩展标签 -->
</extension>
```

如果您有满足条件的情况，最终会执行相应的操作。操作可以是各种各样的事情。您可以设置一个数字检查，看看您是否拨打了3485这个号码，并且查询您是否从特定的电话号码或电话号码中拨打，如果是的话，将执行一个Lua脚本来制作一些吐司。制作好吐司后，下一个操作标签会让打电话者听到"吐司已经准备好了"，然后继续进行更多的条件判断。这些条件可以检查是早上还是下午，然后相应地在吐司上涂抹黄油或果酱。然后它会告诉用户"果酱已经涂好了"，最后挂断电话。不过，这并不一定要结束。

扩展标签的一个重要部分是"continue"参数。

```xml
<extension name="制作吐司" continue="true">
```

在大多数情况下，您不需要continue参数。您可以不设置它。continue默认为'false'，所以除非您有后续操作，否则不需要使用它。如果设置为true，扩展将一直运行，直到完成或通道挂断或销毁。扩展完成后，它**继续按照拨号计划进行下去**，这非常重要。这样可以为您的FreeSWITCH运行方式提供很多灵活性。它可以根据时间为每个呼叫者播放一条消息，而不管目的地是什么，然后按照正常的拨号计划继续执行。但也可以不这样做。一切都取决于您。

---

(也许需要先讨论配置文件、网关、上下文的概念。是否按照这个顺序？还是应该提早讨论？请考虑一下。)

正在进行中！请勿使用。Tod Hansmann还在处理中。欢迎在Freenode上的 #freeswitch 频道中向他咨询。他是TodPunk。